!function(f){f.fn.llmsCollapsible=function(){return this.on("click",".llms-collapsible-header",function(){var e=f(this).closest(".llms-collapsible"),t=e.siblings(".llms-collapsible");e.toggleClass("opened").trigger("llms-collapsible-toggled"),e.find(".llms-collapsible-body").slideToggle(400),t.each(function(){f(this).removeClass("opened"),f(this).find(".llms-collapsible-body").slideUp(400)})}),this},window.llms=window.llms||{};window.llms.metaboxes=new function(){this.repeaters={metaboxes:this,$repeaters:null,init:function(){var e=this;e.$repeaters=f(".llms-mb-list.repeater"),e.$repeaters.length&&(LLMS.wait_for(function(){return"undefined"!=typeof tinyMCE},function(){e.load(),e.bind()}),f('#post input[type="submit"], #post-preview').on("click",function(){f(this).attr("data-llms-clicked","yes")}),f("#post").on("submit",e.handle_submit))},bind:function(){var n=this;n.$repeaters.each(function(){var a=f(this),l=a.find(".llms-repeater-rows");a.find(".llms-repeater-new-btn").on("click",function(){n.add_row(a,null,!0)}),l.sortable({handle:".llms-drag-handle",items:".llms-repeater-row",start:function(e,t){l.addClass("dragging")},stop:function(e,t){l.removeClass("dragging"),t.item.find("textarea.wp-editor-area").each(function(){var e=f(this).attr("id");tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,e),tinyMCE.EditorManager.execCommand("mceAddEditor",!0,e)}),n.save(a)}}),a.on("click",".llms-repeater-remove",function(e){e.stopPropagation();e=f(this).closest(".llms-repeater-row");window.confirm(LLMS.l10n.translate("Are you sure you want to delete this row? This cannot be undone."))&&(e.remove(),setTimeout(function(){n.save(a)},1))})})},add_row:function(e,t,a){var l=this,n=e.find(".llms-repeater-rows"),i=e.find(".llms-repeater-model"),s=l.clone_row(i.find(".llms-repeater-row")),i=e.find(".llms-repeater-row").length,i=l.reindex(s,i);t&&f.each(t,function(e,t){var a=s.find('[name^="'+e+'"]');a.hasClass("llms-select2-student")?(f.each(t,function(e,t){a.append('<option value="'+t.key+'" selected="selected">'+t.title+"</option>")}),a.trigger("change")):a.val(t)}),setTimeout(function(){l.bind_row(s)},1),n.append(s),a&&s.find(".llms-collapsible-header").trigger("click"),tinyMCE.EditorManager.execCommand("mceAddEditor",!0,i),e.trigger("llms-new-repeater-row",{$row:s,data:t})},bind_row:function(e){this.bind_row_header(e),e.find(".llms-select2").llmsSelect2({width:"100%"}),e.find(".llms-select2-student").llmsStudentsSelect2(),this.metaboxes.bind_datepickers(e.find(".llms-datepicker")),this.metaboxes.bind_controllers(e.find("[data-is-controller]"))},bind_row_header:function(e){var t=e.find(".llms-repeater-title"),e=e.find(".llms-collapsible-header-title-field");t.attr("data-default",t.text()),e.on("keyup focusout blur",function(){var e=(e=f(this).val())||t.attr("data-default");t.text(e)}).trigger("keyup")},clone_row:function(e){return($ed=e.find(".editor textarea")).length&&tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,$ed.attr("id")),e.clone()},handle_submit:function(e){var t,a,l,n=f('#post [data-llms-clicked="yes"]'),i=n.parent().find(".spinner");n.is("#post-preview")?n.removeAttr("data-llms-clicked"):(e.preventDefault(),f('#post input[type="submit"]').addClass("disabled").attr("disabled","disabled"),i.addClass("is-active"),t=window.llms.metaboxes.repeaters,a=0,t.$repeaters.each(function(){t.save(f(this))}),l=setInterval(function(){59<=a||!f(".llms-mb-list.repeater.processing").length?(clearInterval(l),f("#post").off("submit",this.handle_submit),i.removeClass("is-active"),n.removeClass("disabled").removeAttr("disabled").trigger("click")):a++},1e3))},load:function(){var l=this;l.$repeaters.each(function(){var a=f(this);a.hasClass("is-loaded")||a.hasClass("processing")||l.store(a,"load",function(e){a.addClass("is-loaded"),f.each(e.data,function(e,t){l.add_row(a,t,!1)}),a.find(".llms-repeater-rows .llms-repeater-row").each(function(){l.bind_row(f(this))})})})},reindex:function(e,a){var l=e.attr("data-row-order"),t=e.find(".llms-mb-list.editor textarea");function n(e,t){e.each(function(){var e=f(this).attr(t);f(this).attr(t,e.replace(l,a))})}return tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,t.attr("id")),e.attr("data-row-order",a),n(e,"data-row-order"),n(e.find("button.insert-media"),"data-editor"),n(e.find('input[name^="_llms"], textarea[name^="_llms"], select[name^="_llms"]'),"id"),n(e.find('input[name^="_llms"], textarea[name^="_llms"], select[name^="_llms"]'),"name"),n(e.find("[data-controller]"),"data-controller"),n(e.find("[data-controller]"),"data-controller"),n(e.find("button.wp-switch-editor"),"data-wp-editor-id"),n(e.find("button.wp-switch-editor"),"id"),n(e.find(".wp-editor-tools"),"id"),n(e.find(".wp-editor-container"),"id"),t.attr("id")},save:function(e){e.trigger("llms-repeater-before-save",{$el:e}),this.store(e,"save")},serialize:function(e){var a=[];return e.find(".llms-repeater-rows .llms-repeater-row").each(function(){var t={};f(this).find('input[name^="_llms"], select[name^="_llms"]').each(function(){t[f(this).attr("name")]=f(this).val()}),f(this).find('textarea[name^="_llms"]').each(function(){var e=f(this).attr("name");tinyMCE.editors[e]?t[e]=tinyMCE.editors[e].getContent():t[e]=f(this).val()}),a.push(t)}),a},store:function(t,e,a){a=a||function(){};var l={action:t.find(".llms-repeater-field-handler").val(),store_action:e};"save"===e&&(l.rows=this.serialize(t)),LLMS.Ajax.call({data:l,beforeSend:function(){t.addClass("processing"),LLMS.Spinner.start(t)},success:function(e){a(e),LLMS.Spinner.stop(t),t.removeClass("processing")}})}},this.repeaters.init(),this.init=function(){var l=this,e=(f(".llms-select2-post").each(function(){l.post_select(f(this))}),f(".llms-collapsible-group").llmsCollapsible(),this.bind_tabs(),this.bind_mce_fixes(),[{selector:f(".llms-datepicker"),func:"bind_datepickers"},{selector:f(".llms-select2"),func:function(e){e.llmsSelect2({width:"100%"})}},{selector:f(".llms-select2-student"),func:function(e){e.llmsStudentsSelect2()}},{selector:f('input[type="checkbox"][data-controls]'),func:"bind_cb_controllers"},{selector:f("[data-is-controller]"),func:"bind_controllers"},{selector:f(".llms-table"),func:"bind_tables"},{selector:f(".llms-merge-code-wrapper"),func:"bind_merge_code_buttons"},{selector:f("a.llms-editable, button.llms-editable"),func:"bind_editables"}]);f.each(e,function(e,t){var a;t.selector.length&&(a=t.selector.filter(function(){return 0===f(this).closest(".llms-repeater-model").length}),"string"==typeof t.func?l[t.func](a):"function"==typeof t.func&&t.func(a))}),window.llms.post.post_type&&"function"==typeof this[e="bind_"+window.llms.post.post_type]&&this[e]()},this.bind_cb_controllers=function(e){(e=e||f('input[type="checkbox"][data-controls]')).each(function(){var e=f(this),t=f(e.attr("data-controls")).closest(".llms-mb-list");e.on("change",function(){f(this).is(":checked")?t.slideDown(200):t.slideUp(200)}),e.trigger("change")})},this.bind_controllers=function(e){(e=e||f("[data-is-controller]")).each(function(){var a,e=f(this),t=f('[data-controller="#'+e.attr("id")+'"]');e.on("change",function(){a="checkbox"!==e.attr("type")||e.is(":checked")?e.val():"false",t.each(function(){var e=f(this).attr("data-controller-value"),t=[];-1!==e.indexOf(",")?t=e.split(","):t.push(e),-1!==t.indexOf(a)?f(this).slideDown(200):f(this).slideUp(200)})}),e.trigger("change")})},this.bind_datepicker=function(e){var t=e.attr("data-format")||"mm/dd/yy",a=e.attr("data-max-date")||null,l=e.attr("data-min-date")||null;e.datepicker({dateFormat:t,maxDate:a,minDate:l})},this.bind_datepickers=function(e){var t=this;(e=e||f(".llms-datepicker")).each(function(){t.bind_datepicker(f(this))})},this.bind_editables=function(){var u=this;f("a.llms-editable, button.llms-editable").on("click",function(e){e.preventDefault();var e=f(this),t=e.attr("data-fields")?f(e.attr("data-fields")):e.closest(".llms-metabox-section").find("[data-llms-editable]");e.remove(),t.each(function(){var e,t,a,l=f(this),n=l.find("label").clone(),i=l.attr("data-llms-editable"),s=l.attr("data-llms-editable-type"),r=l.attr("data-llms-editable-required")||"no",o=l.attr("data-llms-editable-value"),r="yes"===r?' required="required"':"";if("select"===s){var d,c=JSON.parse(l.attr("data-llms-editable-options")),m=f('<select name="'+i+'"'+r+" />");for(d in c)m.append('<option value="'+d+'"'+(o===d?' selected="selected"':"")+">"+c[d]+"</option>")}else"datetime"===s?(m=f('<div class="llms-datetime-field" />'),o=JSON.parse(o),e=l.attr("data-llms-editable-date-format")||"",t=l.attr("data-llms-editable-date-min")||"",a=l.attr("data-llms-editable-date-max")||"",$picker=f('<input class="llms-date-input llms-datepicker" data-format="'+e+'" data-max-date="'+a+'" data-min-date="'+t+'" name="'+i+'[date]" type="text" value="'+o.date+'">'),u.bind_datepicker($picker),m.append($picker),m.append("<em>@</em>"),m.append('<input class="llms-time-input" max="23" min="0" name="'+i+'[hour]" type="number" value="'+o.hour+'">'),m.append("<em>:</em>"),m.append('<input class="llms-time-input" max="59" min="0" name="'+i+'[minute]" type="number" value="'+o.minute+'">')):m=f('<input name="'+i+'" type="'+s+'" value="'+o+'"'+r+">");l.empty().append(n).append(m),"select"===s&&setTimeout(function(){m.trigger("change")},100)})})},this.bind_llms_engagement=function(){var n=this;f("#_llms_engagement_type").on("change",function(){f("#_llms_engagement").trigger("llms-engagement-type-change",f(this).val())}),f("#_llms_engagement").on("llms-engagement-type-change",function(e,t){var a=f(this);switch(t){case"achievement":case"certificate":case"email":var l="llms_"+t;a.val(null).attr("data-post-type",l).trigger("change"),n.post_select(a);break;default:a.trigger("llms-engagement-type-change-external",t)}})},this.bind_llms_membership=function(){var t=f(".llms-mb-list._llms_content_table");function l(){var e=t.find("tbody tr");1===e.length?e.first().show():e.first().hide()}function n(){var e=[];return t.find('tbody tr a[href="#llms-course-remove"]').each(function(){e.push(f(this).attr("data-id"))}),e}l(),t.on("click",'a[href="#llms-course-remove"]',function(e){e.preventDefault();var e=f(this),t=e.closest("tr"),a=e.closest(".llms-mb-list");LLMS.Spinner.start(a),window.LLMS.Ajax.call({data:{action:"membership_remove_auto_enroll_course",course_id:e.attr("data-id")},beforeSend:function(){a.find("p.error").remove()},success:function(e){e.success?(t.fadeOut(200),setTimeout(function(){t.remove(),l()},400)):a.prepend('<p class="error">'+e.message+"</p>"),LLMS.Spinner.stop(a)}})}),t.on("click",'a[href="#llms-course-bulk-enroll"]',function(e){e.preventDefault();var t=f(this),a=(t.closest("tr"),t.closest(".llms-mb-list"));window.confirm(LLMS.l10n.translate("Click okay to enroll all active members into the selected course. Enrollment will take place in the background and you may leave your site after confirmation. This action cannot be undone!"))&&(LLMS.Spinner.start(a),window.LLMS.Ajax.call({data:{action:"bulk_enroll_membership_into_course",course_id:t.attr("data-id")},beforeSend:function(){a.find("p.error").remove()},success:function(e){e.success?t.replaceWith('<strong style="float:right;">'+e.data.message+"&nbsp;&nbsp;</strong>"):a.prepend('<p class="error">'+e.message+"</p>"),LLMS.Spinner.stop(a)}}))}),f("#_llms_auto_enroll").on("change",function(){var e,t=f(this).val(),a=f(this).find('option[value="'+f(this).val()+'"]').text();t&&(-1!==n().indexOf(t)?(alert(LLMS.l10n.replace('"%s" is already in the course list.',{"%s":a})),f(this).val("").trigger("change")):(e=f(".llms-mb-list._llms_content_table"),($tr=f("<tr />")).append('<td><span class="dashicons dashicons-menu llms-drag-handle ui-sortable-handle"></span></td>'),$tr.append('<td><a href="'+window.llms.admin_url+"post.php?action=edit&post="+t+'">'+a+"</a></td>"),$tr.append('<td><a class="llms-button-danger small" data-id="'+t+'" href="#llms-course-remove" style="float:right;">'+LLMS.l10n.translate("Remove course")+'</a><a class="llms-button-secondary small" data-id="'+t+'" href="#llms-course-bulk-enroll" style="float:right;margin-right:5px;">'+LLMS.l10n.translate("Enroll All Members")+"</a></td>"),e.find("table tbody").append($tr),f(this).val("").trigger("change"),l(),e.trigger("llms-save-autoenroll-courses")))}),t.find("table tbody").sortable({handle:".llms-drag-handle",stop:function(e,t){t.item.closest(".llms-mb-list").trigger("llms-save-autoenroll-courses")}}),t.on("llms-save-autoenroll-courses",function(){var e=f(this);LLMS.Spinner.start(e),window.LLMS.Ajax.call({data:{action:"llms_save_membership_autoenroll_courses",courses:n()},error:function(e,t,a){alert(a)},complete:function(){LLMS.Spinner.stop(e)}})})},this.bind_llms_order=function(){f('button[name="llms-refund-toggle"]').on("click",function(){var e=f(this),t=e.closest("tr"),a=t.attr("data-transaction-id"),l=e.attr("data-refundable"),n="1"===e.attr("data-gateway-supports"),i=e.attr("data-gateway"),s=f("#llms-txn-refund-model .llms-txn-refund-form").clone(),r=s.find(".gateway-btn");"remove"!==e.attr("data-action")?(e.text(LLMS.l10n.translate("Cancel")),e.attr("data-action","remove"),s.find("input").removeAttr("disabled"),s.find('input[name="llms_refund_amount"]').attr("max",l),s.find('input[name="llms_refund_txn_id"]').val(a),n&&(r.find(".llms-gateway-title").text(i),r.show()),t.after(s)):(e.text(LLMS.l10n.translate("Refund")),e.attr("data-action",""),t.next("tr").remove())}),f('button[name="llms-manual-txn-toggle"]').on("click",function(){var e=f(this),t=e.closest("tr"),a=f("#llms-manual-txn-model .llms-manual-txn-form").clone();"remove"!==e.attr("data-action")?(e.text(LLMS.l10n.translate("Cancel")),e.attr("data-action","remove"),a.find("input").removeAttr("disabled"),t.after(a)):(e.text(LLMS.l10n.translate("Record a Manual Payment")),e.attr("data-action",""),t.next("tr").remove())}),f(".llms-metabox").one("focus",'.llms-metabox-field[data-llms-editable="payment_gateway"] select',function(){f(this).attr("data-original-value")||f(this).attr("data-original-value",f(this).val())}),f(".llms-metabox").on("change",'.llms-metabox-field[data-llms-editable="payment_gateway"] select',function(){var e,t=f(this),a=t.val(),l=JSON.parse(t.closest(".llms-metabox-field").attr("data-gateway-fields"))[a];for(e in l){var n=f('input[name="'+l[e].name+'"]'),i=n.closest(".llms-metabox-field");l[e].enabled?(i.show(),n.attr("required","required"),n.removeAttr("disabled"),a===t.attr("data-original-value")&&n.val(i.attr("data-llms-editable-value"))):(n.attr("value",""),n.removeAttr("required"),i.hide())}})},this.bind_mce_fixes=function(){void 0===wp.data||[null,void 0].includes(wp.data.select("core/edit-post"))||LLMS.wait_for(function(){return void 0!==wp.data.select("core/edit-post").getMetaBoxesPerLocation("normal")},function(){var e=!1;for(t in find=["lifterlms-product","lifterlms-membership","lifterlms-course-options"],metaboxes=wp.data.select("core/edit-post").getMetaBoxesPerLocation("normal"))if(-1!==find.indexOf(metaboxes[t].id)){e=!0;break}if(e){var t,a,l={};for(t in tinyMCE.EditorManager.editors)"excerpt"!==(a=t)&&-1===a.indexOf("llms")&&-1===a.indexOf("lifterlms")||(l[t]=tinyMCE.EditorManager.get(t),tinyMCE.EditorManager.execCommand("mceRemoveEditor",!0,t));setTimeout(function(){for(var e in l)tinyMCE.EditorManager.init(l[e].settings||tinyMCE.EditorManager.settings)},500)}})},this.bind_merge_code_buttons=function(e){(e=e||f(".llms-merge-code-wrapper")).find(".llms-merge-code-button").on("click",function(){f(this).next(".llms-merge-codes").toggleClass("active")}),e.find(".llms-merge-codes li").on("click",function(){var e,t=f(this),a=t.closest(".llms-merge-codes"),l=a.attr("data-target"),t=t.attr("data-code");-1===l.indexOf("#")?(e=window.tinymce.editors[l])?e.insertContent(t):alert(LLMS.l10n.translate("Copy this code and paste it into the desired area")+": "+t):f(l).val(f(l).val()+t),a.removeClass("active")})},this.bind_tabs=function(){f(".llms-nav-tab-wrapper .tabs li").on("click",function(){var e=f(this),t=e.closest(".llms-mb-container"),a=e.attr("data-tab");e.siblings().removeClass("llms-active"),t.find(".tab-content").removeClass("llms-active"),e.addClass("llms-active"),f("#"+a).addClass("llms-active")})},this.post_select=function(e){var t,a="multiple"===e.attr("multiple"),l=e.attr("data-no-view-button");e.llmsPostsSelect2({width:a||l?"100%":"65%"}),a||l||(a=LLMS.l10n.translate("View"),t=f('<a class="llms-button-secondary small" style="margin-left:5px;" target="_blank" href="#">'+a+' <i class="fa fa-external-link" aria-hidden="true"></i></a>'),e.next(".select2").after(t),e.on("change",function(){var e=f(this).val();e?t.attr("href",window.llms.home_url+"/?p="+e).show():t.hide()}).trigger("change"))},this.bind_tables=function(){f('.llms-table button[name="llms-expand-table"]').on("click",function(){var e,t=f(this),a=t.closest(".llms-table");t.attr("data-text")&&(e=t.text(),t.text(t.attr("data-text")),t.attr("data-text",e)),a.find(".expandable").each(function(){f(this).hasClass("closed")?f(this).addClass("opened").removeClass("closed"):f(this).addClass("closed").removeClass("opened")})})},this.init()}}(jQuery);
//# sourceMappingURL=../maps/js/llms-metaboxes.min.js.map
